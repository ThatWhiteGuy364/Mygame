
name: Build Cordova Android APK

on:
  push:
    branches: [ add/cordova-project ]
  workflow_dispatch:

jobs:
  build-android:
    runs-on: ubuntu-latest
    env:
      # r0adkll/setup-android sets ANDROID_SDK_ROOT; kept for clarity
      ANDROID_SDK_ROOT: ${{ github.workspace }}/android-sdk

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Java (Temurin 17)
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18

      - name: Install Android SDK & build tools (API 34 & 35, build-tools 35.0.0)
        uses: r0adkll/setup-android@v2
        with:
          api-levels: 34,35
          build-tools: 35.0.0
          components: platform-tools
          ndk: ""
          cmake: ""
          # install path will be available as ANDROID_HOME/ANDROID_SDK_ROOT in the runner

      - name: Install Cordova CLI
        run: npm install -g --unsafe-perm cordova@latest

      - name: Ensure www/index.html exists (or copy from repo root index.html)
        run: |
          if [ -f "www/index.html" ]; then
            echo "Found www/index.html"
          elif [ -f "index.html" ]; then
            echo "Copying index.html -> www/index.html"
            mkdir -p www
            cp index.html www/index.html
          else
            echo "::warning::No www/index.html or index.html found in repo. Make sure your app HTML is present in the repo at www/index.html or index.html."
          fi

      - name: Clean previous Android platform (if present)
        run: |
          if cordova platform ls 2>/dev/null | grep -q "android"; then
            cordova platform rm android || true
          fi

      - name: Add Android platform
        env:
          JAVA_HOME: ${{ env.JAVA_HOME }}
          ANDROID_SDK_ROOT: ${{ env.ANDROID_SDK_ROOT }}
        run: |
          cordova platform add android

      - name: Build Android debug APK
        env:
          JAVA_HOME: ${{ env.JAVA_HOME }}
          ANDROID_SDK_ROOT: ${{ env.ANDROID_SDK_ROOT }}
        run: |
          cordova build android --debug --verbose

      - name: Upload debug APK artifact
        uses: actions/upload-artifact@v4
        with:
          name: app-debug-apk
          path: platforms/android/app/build/outputs/apk/debug/app-debug.apk
